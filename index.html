<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyectos Alex | Curated Projects</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,600;0,800;1,600&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Iconos Phosphor para un look más moderno -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --bg-body: #FAFAFA;
            --bg-card: #FFFFFF;
            --text-main: #18181B;
            --text-muted: #71717A;
            --primary: #18181B; /* Negro elegante */
            --primary-hover: #27272A;
            --accent: #6366F1; /* Índigo sutil para detalles */
            --accent-gradient: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            --border: #E4E4E7;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-hover: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius: 1rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            line-height: 1.6;
            overflow-x: hidden;
        }

        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; color: var(--text-main); letter-spacing: -0.02em; }
        
        input, button, textarea, select { font-family: inherit; outline: none; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
        .hidden { display: none !important; }

        /* --- NAVEGACIÓN (Glassmorphism) --- */
        nav { 
            position: sticky; top: 0; z-index: 100; 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        nav .container { display: flex; height: 5rem; align-items: center; justify-content: space-between; }
        
        .nav-brand { display: flex; align-items: center; gap: 0.75rem; text-decoration: none; color: inherit; transition: opacity 0.2s; }
        .nav-brand:hover { opacity: 0.8; }
        .nav-brand span { font-size: 1.25rem; font-weight: 800; letter-spacing: -0.03em; }

        .logo-svg { width: 2.5rem; height: 2.5rem; }

        .nav-buttons { display: flex; align-items: center; gap: 0.75rem; }

        /* --- BOTONES MODERNOS --- */
        button, .btn { 
            padding: 0.6rem 1.2rem; border: none; border-radius: 99px; 
            cursor: pointer; font-size: 0.9rem; font-weight: 500; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary { background-color: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--text-main); background: white; }

        .btn-ghost { background: transparent; color: var(--text-muted); padding: 0.5rem; }
        .btn-ghost:hover { color: var(--text-main); background: rgba(0,0,0,0.03); }

        .btn-premium { 
            background: var(--accent-gradient); color: white; border: none;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .btn-premium:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4); filter: brightness(1.1); }

        /* --- HERO SECTION --- */
        .hero { padding: 8rem 0 6rem; text-align: center; position: relative; overflow: hidden; }
        /* Fondo sutil decorativo */
        .hero::before {
            content: ''; position: absolute; top: -50%; left: 50%; transform: translateX(-50%);
            width: 100%; height: 100%; max-width: 800px;
            background: radial-gradient(circle, rgba(99,102,241,0.08) 0%, rgba(255,255,255,0) 70%);
            z-index: -1;
        }
        
        .hero-badge { 
            display: inline-block; padding: 0.35rem 1rem; border-radius: 99px; 
            background: white; border: 1px solid var(--border); 
            font-size: 0.8rem; font-weight: 600; color: var(--text-muted);
            margin-bottom: 2rem; box-shadow: var(--shadow-sm);
        }
        
        .hero h1 { 
            font-size: 4rem; line-height: 1.1; margin-bottom: 1.5rem; 
            background: -webkit-linear-gradient(#18181B, #52525B); -webkit-background-clip: text;
        }
        .hero p { font-size: 1.25rem; color: var(--text-muted); max-width: 600px; margin: 0 auto 2.5rem; font-weight: 300; }

        /* --- SEARCH --- */
        .search-section { padding: 0 0 4rem; }
        .search-box-wrapper {
            max-width: 500px; margin: 0 auto; position: relative;
            background: white; border-radius: 99px; 
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08);
            border: 1px solid transparent; transition: all 0.3s;
        }
        .search-box-wrapper:focus-within { border-color: var(--border); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.12); transform: translateY(-2px); }
        
        .search-box-wrapper i { position: absolute; left: 1.5rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 1.2rem; }
        .search-box-wrapper input { 
            width: 100%; padding: 1.2rem 1.5rem 1.2rem 3.5rem; 
            border: none; background: transparent; font-size: 1rem; 
            border-radius: 99px; color: var(--text-main);
        }

        /* --- CARDS DE PROYECTOS --- */
        .projects-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 2.5rem; padding-bottom: 4rem; 
        }

        .project-card { 
            background: var(--bg-card); border-radius: var(--radius); 
            border: 1px solid var(--border); transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .project-card:hover { 
            transform: translateY(-8px); 
            box-shadow: var(--shadow-hover); 
            border-color: transparent;
        }

        .project-card.is-premium { border: 1px solid #FCD34D; }
        .project-card.is-premium::after {
            content: ''; position: absolute; inset: 0; border-radius: var(--radius);
            box-shadow: inset 0 0 0 1px rgba(252, 211, 77, 0.3), 0 10px 40px -10px rgba(245, 158, 11, 0.1);
            pointer-events: none;
        }

        .project-image-container { position: relative; height: 240px; overflow: hidden; cursor: pointer; }
        .project-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.6s; }
        .project-card:hover .project-image { transform: scale(1.05); }
        
        .project-image-placeholder {
            width: 100%; height: 100%; 
            background: linear-gradient(45deg, #f3f4f6 25%, #ffffff 25%, #ffffff 50%, #f3f4f6 50%, #f3f4f6 75%, #ffffff 75%, #ffffff 100%);
            background-size: 20px 20px;
            display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-size: 3rem;
        }

        .card-content { padding: 1.5rem; display: flex; flex-direction: column; flex: 1; }
        
        .card-category { 
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; 
            color: var(--accent); font-weight: 700; margin-bottom: 0.5rem;
        }
        
        .card-title { 
            font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; 
            line-height: 1.3; font-family: 'Playfair Display', serif; cursor: pointer;
        }
        .card-title:hover { color: var(--accent); }

        .card-desc { 
            font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1.5rem; 
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }

        .card-footer { 
            margin-top: auto; padding-top: 1rem; border-top: 1px solid #F4F4F5; 
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Autor & Likes */
        .author-info { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        .author-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #F4F4F5; }
        .author-name { font-size: 0.85rem; font-weight: 500; color: var(--text-main); }
        
        .like-btn { 
            display: flex; align-items: center; gap: 0.25rem; background: none; border: none; 
            font-size: 0.85rem; color: var(--text-muted); cursor: pointer; transition: all 0.2s;
            padding: 0.25rem 0.5rem; border-radius: 99px;
        }
        .like-btn:hover { background: #FEF2F2; color: #EF4444; }
        .like-btn.liked { color: #EF4444; }
        .like-btn.liked i { font-weight: fill; }

        /* --- MODALES (Glass Clean) --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(8px);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-card { 
            background: white; width: 100%; max-width: 450px; padding: 3rem; 
            border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); 
            border: 1px solid rgba(0,0,0,0.05); transform: translateY(20px); transition: all 0.3s; 
        }
        .modal-overlay.active .modal-card { transform: translateY(0); }

        /* --- FORMULARIOS --- */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border); 
            border-radius: 0.5rem; font-size: 0.95rem; transition: border-color 0.2s;
            background: #FAFAFA;
        }
        .form-group input:focus { border-color: var(--text-main); background: white; }

        /* --- TOAST & ADS --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #18181B; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out forwards; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .ad-container { width: 100%; margin: 3rem 0; display: flex; justify-content: center; }
        .ad-placeholder { 
            width: 100%; max-width: 728px; height: 90px; 
            background-color: #F4F4F5; border-radius: 0.5rem; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: #A1A1AA; font-size: 0.8rem; letter-spacing: 0.05em; text-transform: uppercase;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2.5rem; }
            .nav-brand span { display: none; }
            .projects-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- NAVEGACIÓN -->
    <nav>
        <div class="container">
            <a onclick="showPage('home')" class="nav-brand">
                <svg class="logo-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="100" cy="100" r="100" fill="#F9F7F2" />
                    <circle cx="100" cy="100" r="92" fill="none" stroke="#1A1A1A" stroke-width="1" />
                    <defs>
                        <path id="textCircleTop" d="M 30,100 A 70,70 0 1,1 170,100" />
                        <path id="textCircleBottom" d="M 25,100 A 75,75 0 0,0 175,100" />
                    </defs>
                    <text font-family="'Inter', sans-serif" font-size="16" font-weight="700" fill="#1A1A1A" letter-spacing="2">
                        <textPath href="#textCircleTop" startOffset="50%" text-anchor="middle">PROYECTOSALEX</textPath>
                    </text>
                    <text x="100" y="108" font-family="'Playfair Display', serif" font-size="70" font-weight="800" fill="#1A1A1A" text-anchor="middle" dominant-baseline="middle">PA</text>
                    <text x="100" y="140" font-family="'Inter', sans-serif" font-size="10" font-weight="600" fill="#1A1A1A" text-anchor="middle" letter-spacing="1">EST. 2024</text>
                    <text font-family="'Inter', sans-serif" font-size="8" font-weight="600" fill="#1A1A1A" letter-spacing="1">
                        <textPath href="#textCircleBottom" startOffset="50%" text-anchor="middle">SMALL STEPS • LONG DISTANCES</textPath>
                    </text>
                </svg>
                <span>Proyectos Alex</span>
            </a>
            
            <div class="nav-buttons">
                <button class="btn btn-ghost hidden" id="backHomeBtn" onclick="showPage('home')"><i class="ph ph-house"></i> Inicio</button>
                
                <div id="authButtons">
                    <button class="btn btn-outline" onclick="openAuthModal('login')">Ingresar</button>
                    <button class="btn btn-primary" onclick="openAuthModal('signup')">Registrarse</button>
                </div>

                <div id="userMenu" class="hidden" style="display: flex; align-items: center; gap: 0.5rem;">
                     <button class="btn btn-outline" onclick="showPage('dashboard')">
                        <i class="ph ph-user"></i> Mi Cuenta
                     </button>
                     <button class="btn btn-ghost" onclick="handleLogout()" title="Salir">
                        <i class="ph ph-sign-out" style="font-size: 1.2rem;"></i>
                     </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- PÁGINA: HOME -->
    <div id="home" class="page active">
        <header class="hero">
            <div class="container">
                <span class="hero-badge">✨ Plataforma de Curación de Proyectos</span>
                <h1>Dale Vida a Tus <br><span style="color: #6366F1; font-style: italic;">Grandes Ideas</span></h1>
                <p>El espacio definitivo para creadores, emprendedores y visionarios. Comparte tu trabajo, recibe feedback y conecta con el mundo.</p>
                
                <div class="search-section">
                    <div class="search-box-wrapper">
                        <i class="ph ph-magnifying-glass"></i>
                        <input type="text" placeholder="Buscar por creador, categoría o proyecto..." onkeyup="filterProjects(this.value, 'homeProjectsGrid')">
                    </div>
                </div>
                
                <div class="hero-buttons">
                    <button class="btn btn-primary" onclick="handleCreateProjectClick()">Publicar Proyecto <i class="ph ph-arrow-right"></i></button>
                </div>
            </div>
        </header>

        <div class="ad-container"><div class="ad-placeholder"><span class="ad-label">Sponsors</span><span class="ad-content">Google AdSense</span></div></div>

        <section class="container">
            <h3 style="margin-bottom: 2rem; font-size: 1.5rem;">Proyectos Destacados</h3>
            <div id="homeProjectsGrid" class="projects-grid"></div>
        </section>
    </div>

    <!-- PÁGINA: DASHBOARD -->
    <div id="dashboard" class="page">
        <div class="dashboard-header">
            <div class="container" style="padding: 3rem 0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="display: flex; gap: 1.5rem; align-items: center;">
                         <img id="dashboardAvatar" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);" src="">
                         <div>
                             <h2 id="userNameDisplay" style="margin-bottom: 0.25rem;">Usuario</h2>
                             <p id="userEmailDisplay" style="color: var(--text-muted);">email@ejemplo.com</p>
                             <button onclick="openEditProfile()" style="font-size: 0.8rem; color: var(--accent); background: none; padding: 0; margin-top: 0.5rem;">Editar perfil</button>
                         </div>
                    </div>
                    <button class="btn btn-primary" onclick="showPage('create-project')"><i class="ph ph-plus"></i> Nuevo Proyecto</button>
                </div>
            </div>
        </div>

        <div class="container" style="margin-top: 2rem;">
             <div class="stats-grid">
                <div class="stat-card"><h3>Mis Proyectos</h3><div class="value" id="userProjectCount">0</div></div>
                <div class="stat-card"><h3>Destacados</h3><div class="value" id="userPremiumCount">0</div></div>
            </div>
            <h3 style="margin: 2rem 0;">Mi Portfolio</h3>
            <div id="myProjectsGrid" class="projects-grid"></div>
        </div>
    </div>

    <!-- PÁGINA: CREAR/EDITAR FORMULARIOS (Simplificado visualmente) -->
    <div id="create-project" class="page">
        <div class="container" style="padding: 4rem 0;">
            <div class="form-container">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2>Publicar Proyecto</h2>
                    <button class="btn btn-ghost" onclick="showPage('dashboard')"><i class="ph ph-x"></i></button>
                </div>
                <form onsubmit="submitProject(event)">
                    <div class="form-group"><label>Título</label><input type="text" id="pTitle" required></div>
                    <div class="form-group"><label>Categoría</label><select id="pCat"><option>Tecnología</option><option>Diseño</option><option>Arte</option><option>Negocios</option></select></div>
                    <div class="form-group"><label>Descripción</label><textarea id="pDesc" rows="4" required></textarea></div>
                    <div class="form-group"><label>Precio (€)</label><input type="number" id="pPrice" min="0" step="0.01" required></div>
                    <div class="form-group">
                         <label>Imagen de Portada</label>
                         <input type="file" id="pImgFile" accept="image/*" onchange="handleImagePreview(this, 'pImgUrl')">
                         <input type="hidden" id="pImgUrl">
                    </div>
                    <div class="form-group"><label>Web del Proyecto (Opcional)</label><input type="url" id="pUrl" placeholder="https://..."></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Publicar Ahora</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODALES (LOGIN / PREMIUM / PERFIL) -->
    
    <!-- Auth Modal -->
    <div id="authModal" class="modal-overlay">
        <div class="modal-card">
            <button class="close-modal" onclick="closeAuthModal()"><i class="ph ph-x"></i></button>
            <h2 id="authTitle" style="text-align: center; margin-bottom: 1.5rem;">Bienvenido</h2>
            <div id="authErrorMsg" class="error-message hidden">Datos incorrectos</div>
            
            <form onsubmit="handleAuthSubmit(event)">
                <div class="form-group hidden" id="nameGroup"><label>Nombre</label><input type="text" id="authName"></div>
                <div class="form-group hidden" id="avatarGroup"><label>Foto (Opcional)</label><input type="file" id="authAvatarFile" onchange="handleImagePreview(this, 'authAvatarUrl')"><input type="hidden" id="authAvatarUrl"></div>
                
                <div class="form-group"><label>Email</label><input type="email" id="authEmail" required></div>
                <div class="form-group"><label>Contraseña</label><input type="password" id="authPass" required></div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="authSubmitBtn">Continuar</button>
            </form>
            
            <p class="toggle-auth" onclick="toggleAuthMode()" id="authToggleLink" style="cursor:pointer; margin-top: 1rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;">¿No tienes cuenta? <span style="color: var(--accent); font-weight: 600;">Regístrate</span></p>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script>
        // *** CONFIGURACIÓN SUPABASE ***
        const supabaseUrl = 'https://jvshcszolovsnqzkozka.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2c2hjc3pvbG92c25xemtvemthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMDQ5NDgsImV4cCI6MjA3OTU4MDk0OH0.ty4wwxMhQ8gm1SgweSf9JxcDrvt2IGwKzkH4EQP8ZB4';
        const supabase = window.supabase ? window.supabase.createClient(supabaseUrl, supabaseKey) : null;

        let projects = [];
        let currentUser = JSON.parse(localStorage.getItem('alex_session')) || null;
        let isLoginMode = true;

        document.addEventListener('DOMContentLoaded', async () => {
            updateUI();
            await fetchProjects();
        });

        // --- CORE DATA FUNCTIONS ---
        async function fetchProjects() {
            if (supabase) {
                // Recuperamos proyectos y sus likes count
                const { data, error } = await supabase.from('projects').select('*').order('created_at', { ascending: false });
                if (!error) { projects = data; }
            } else {
                projects = JSON.parse(localStorage.getItem('alex_projects')) || [];
            }
            renderProjects(projects);
        }

        // --- LIKES SYSTEM ---
        async function toggleLike(btn, projectId) {
            if (!currentUser) { showToast("Inicia sesión para dar like", "error"); openAuthModal('login'); return; }
            
            // UI Optimista
            const icon = btn.querySelector('i');
            const countSpan = btn.querySelector('span');
            let currentCount = parseInt(countSpan.textContent);
            const isLiked = btn.classList.contains('liked');

            // Cambiar UI inmediatamente
            btn.classList.toggle('liked');
            icon.className = isLiked ? 'ph ph-heart' : 'ph-fill ph-heart';
            countSpan.textContent = isLiked ? currentCount - 1 : currentCount + 1;

            if (supabase) {
                // Lógica Real Base de Datos
                try {
                    if (!isLiked) {
                        // Dar like
                        await supabase.from('project_likes').insert([{ project_id: projectId, user_email: currentUser.email }]);
                        await supabase.rpc('increment_likes', { row_id: projectId }); // Asume que creaste esta función RPC, sino usa update normal
                        // Fallback si no hay RPC: update manual
                         const { data: p } = await supabase.from('projects').select('likes_count').eq('id', projectId).single();
                         await supabase.from('projects').update({ likes_count: (p.likes_count || 0) + 1 }).eq('id', projectId);
                    } else {
                        // Quitar like
                        await supabase.from('project_likes').delete().match({ project_id: projectId, user_email: currentUser.email });
                        const { data: p } = await supabase.from('projects').select('likes_count').eq('id', projectId).single();
                        await supabase.from('projects').update({ likes_count: Math.max(0, (p.likes_count || 0) - 1) }).eq('id', projectId);
                    }
                } catch (e) {
                    console.error("Error likes", e);
                }
            }
        }

        // --- RENDERIZADO ---
        function renderProjects(list, gridId = 'homeProjectsGrid') {
            const grid = document.getElementById(gridId);
            if (!grid) return;
            
            if (list.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-muted);">No hay proyectos para mostrar aún.</div>';
                return;
            }

            grid.innerHTML = list.map(p => {
                // Normalizar datos
                const img = p.image_url || p.imageUrl || null;
                const title = p.title;
                const cat = p.category;
                const desc = p.description;
                const price = p.price;
                const author = p.author_name || p.authorName || 'Anónimo';
                const avatar = p.author_avatar || p.authorAvatar || null;
                const isPrem = p.is_premium || p.isPremium;
                const likes = p.likes_count || 0;

                let imgHtml = img 
                    ? `<div class="project-image-container"><img src="${img}" class="project-image" alt="${title}"></div>`
                    : `<div class="project-image-container"><div class="project-image-placeholder"><i class="ph ph-cube"></i></div></div>`;
                
                let avatarHtml = avatar 
                    ? `<img src="${avatar}" class="author-avatar">`
                    : `<div class="author-avatar" style="display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.8rem;color:var(--text-muted);">${author.charAt(0)}</div>`;

                return `
                <article class="project-card ${isPrem ? 'is-premium' : ''}">
                    ${imgHtml}
                    <div class="card-content">
                        <span class="card-category">${cat}</span>
                        <h3 class="card-title">${title}</h3>
                        <p class="card-desc">${desc}</p>
                        
                        <div class="card-footer">
                            <div class="author-info">
                                ${avatarHtml}
                                <span class="author-name">${author}</span>
                            </div>
                            <button class="like-btn" onclick="toggleLike(this, ${p.id})">
                                <i class="ph ph-heart"></i>
                                <span>${likes}</span>
                            </button>
                        </div>
                        ${isPrem ? '<div class="premium-badge" style="margin-top:1rem;"><i class="ph-fill ph-star"></i> Destacado</div>' : ''}
                    </div>
                </article>
                `;
            }).join('');
        }

        // --- HELPERS DE IMAGEN ---
        function handleImagePreview(input, outputId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById(outputId).value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // --- AUTH & NAVIGATION ---
        function updateUI() {
            const authBtns = document.getElementById('authButtons');
            const userMenu = document.getElementById('userMenu');
            const backHome = document.getElementById('backHomeBtn');
            
            if (currentUser) {
                authBtns.classList.add('hidden');
                userMenu.classList.remove('hidden');
            } else {
                authBtns.classList.remove('hidden');
                userMenu.classList.add('hidden');
            }
            
            // Mostrar botón Inicio si no estamos en home
            const isHome = document.getElementById('home').classList.contains('active');
            if (isHome) backHome.classList.add('hidden');
            else backHome.classList.remove('hidden');
        }

        function handleAuthSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('authSubmitBtn');
            btn.textContent = 'Procesando...';
            
            setTimeout(async () => {
                const email = document.getElementById('authEmail').value.toLowerCase();
                const pass = document.getElementById('authPass').value;
                
                // Simulación Auth Local (Para producción usar supabase.auth)
                let users = JSON.parse(localStorage.getItem('alex_users')) || [];
                
                if (isLoginMode) {
                    const user = users.find(u => u.email === email && u.pass === pass);
                    if (user) {
                        currentUser = user;
                        localStorage.setItem('alex_session', JSON.stringify(user));
                        closeAuthModal();
                        updateUI();
                        showPage('dashboard');
                        showToast(`Bienvenido de nuevo, ${user.name}`);
                    } else {
                        document.getElementById('authErrorMsg').classList.remove('hidden');
                    }
                } else {
                    // Registro
                    const name = document.getElementById('authName').value;
                    const avatar = document.getElementById('authAvatarUrl').value;
                    const newUser = { name, email, pass, avatar };
                    users.push(newUser);
                    localStorage.setItem('alex_users', JSON.stringify(users));
                    currentUser = newUser;
                    localStorage.setItem('alex_session', JSON.stringify(newUser));
                    closeAuthModal();
                    updateUI();
                    showPage('dashboard');
                    showToast('¡Cuenta creada con éxito!');
                }
                btn.textContent = isLoginMode ? 'Ingresar' : 'Registrarse';
            }, 800);
        }

        function handleLogout() {
            localStorage.removeItem('alex_session');
            currentUser = null;
            updateUI();
            showPage('home');
            showToast('Has cerrado sesión');
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0,0);
            
            if(pageId === 'dashboard') updateDashboard();
            updateUI(); // Actualizar visibilidad de botones
        }

        function openAuthModal(mode) {
            isLoginMode = (mode === 'login');
            const title = document.getElementById('authTitle');
            const submitBtn = document.getElementById('authSubmitBtn');
            const toggleText = document.getElementById('authToggleLink');
            const nameGroup = document.getElementById('nameGroup');
            const avatarGroup = document.getElementById('avatarGroup');
            
            document.getElementById('authErrorMsg').classList.add('hidden');
            document.getElementById('authModal').classList.add('active');
            
            if(isLoginMode) {
                title.textContent = "Bienvenido de nuevo";
                submitBtn.textContent = "Ingresar";
                toggleText.textContent = "Crear cuenta nueva";
                nameGroup.classList.add('hidden');
                avatarGroup.classList.add('hidden');
                document.getElementById('authName').removeAttribute('required');
            } else {
                title.textContent = "Únete a la comunidad";
                submitBtn.textContent = "Crear Cuenta";
                toggleText.textContent = "Ya tengo cuenta";
                nameGroup.classList.remove('hidden');
                avatarGroup.classList.remove('hidden');
                document.getElementById('authName').setAttribute('required', 'true');
            }
        }
        
        function closeAuthModal() { document.getElementById('authModal').classList.remove('active'); }
        function toggleAuthMode() { openAuthModal(isLoginMode ? 'signup' : 'login'); }

        function showToast(msg, type='success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeft = type === 'error' ? '4px solid #ef4444' : '4px solid #10b981';
            toast.textContent = msg;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // --- PROYECTOS CRUD ---
        async function submitProject(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            const newProject = {
                title: document.getElementById('pTitle').value,
                description: document.getElementById('pDesc').value,
                category: document.getElementById('pCat').value,
                price: document.getElementById('pPrice').value,
                image_url: document.getElementById('pImgUrl').value,
                business_url: document.getElementById('pUrl').value,
                author_name: currentUser.name,
                author_email: currentUser.email,
                author_avatar: currentUser.avatar
            };

            if(supabase) {
                await supabase.from('projects').insert([newProject]);
                await fetchProjects(); // Recargar
            }
            showPage('home');
            showToast('¡Proyecto publicado!');
        }
        
        function filterProjects(val, gridId) {
            const term = val.toLowerCase();
            const filtered = projects.filter(p => 
                p.title.toLowerCase().includes(term) || 
                (p.author_name || '').toLowerCase().includes(term) ||
                (p.category || '').toLowerCase().includes(term)
            );
            renderProjects(filtered, gridId);
        }

        function handleCreateProjectClick() {
            if (currentUser) showPage('create-project');
            else openAuthModal('signup');
        }

    </script>
</body>
</html>
